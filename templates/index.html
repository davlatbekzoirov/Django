{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Upload</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link
    href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
    rel="stylesheet"
  />
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="logo">
              <img src="{% static '/image.png' %}" alt="" />
          <p>BMS</p>
            </div>
            <nav>
                <ul>
                    <li><a href="{% url 'index' %}" class="active"><i class="ri-calendar-todo-fill"></i> Schedule</a></li>
                    <li><a href="{% url 'dashboard' %}"><i class="ri-apps-2-fill"></i> Dashboard</a></li>
                </ul>
            </nav>
        </div>
        <div class="main-content">
            <h1>Schedule</h1>
            <div class="form-container">
                <form id="upload-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group" id="form_group1">
                        {{ form.file.label_tag }}
                        <input type="file" name="file"  accept=".xlsx" id="fileinp" class="fileIn">
                        <span id="spanbtn">Add</span>
                    </div>
                    <div class="together">
                      <div class="form-group" style="display: flex; align-items: center;">
                          {{ form.semestr.label_tag }} {{ form.semestr }}
                        </div>
                        <div class="form-group">
                          {{ form.year.label_tag }} {{ form.year }}
                        </div>
                  </div>
                    <div class="form-group" id="deadline">
                        {{ form.from_msheets_dataonth.label_tag }}
                        {{ form.from_month }}
                        <span> - </span>
                        {{ form.to_month.label_tag }}
                        {{ form.to_month }}
                    </div>
                    <button type="submit" id="submit">Upload</button>
                </form>
            </div>
            <div class="schedule-details">
                {% if sheets_data %}
                    <h2>Schedule Details</h2>
                    <p><strong>Semester:</strong> {{ semestr }}</p>
                    <p><strong>Year:</strong> {{ year }}</p>
                    <p><strong>Heatingsheets_data operating period:</strong> {{ from_month }} - {{ to_month }}</p>

                    <label for="sheet-select">Select Sheet</label>
                    <select id="sheet-select">
                        {% for sheet_name in sheets_data.keys %}
                            <option value="{{ sheet_name }}">{{ sheet_name }}</option>
                        {% endfor %}
                    </select>

                    <table class="schedule-table">
                        <thead>
                            <tr id="schedule-table-header">
                                {% for cell in schedule_data.0 %}
                                    <th>{{ cell }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody id="schedule-table-body">
                            {% for row in schedule_data|slice:"1:" %}
                                <tr>
                                    {% for cell in row %}
                                        <td>{{ cell }}</td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function(){
            $('#sheet-select').change(function(){
                var sheetName = $(this).val();
                var formData = new FormData($('#upload-form')[0]);
                formData.append('sheet_name', sheetName);

                $.ajax({
                    url: '',
                    type: 'POST',
                    headers: {'X-Requested-With': 'XMLHttpRequest'},
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data){
                        var scheduleData = data.schedule_data;
                        var tbody = $('#schedule-table-body');
                        var thead = $('#schedule-table-header');
                        tbody.empty();
                        thead.empty();

                        // Render new table header
                        var headerRow = $('<tr></tr>');
                        for(var i = 0; i < scheduleData[0].length; i++){
                            headerRow.append('<th>' + scheduleData[0][i] + '</th>');
                        }
                        thead.append(headerRow);

                        // Render new table rows
                        for(var i = 1; i < scheduleData.length; i++){
                            var row = $('<tr></tr>');
                            for(var j = 0; j < scheduleData[i].length; j++){
                                row.append('<td>' + scheduleData[i][j] + '</td>');
                            }
                            tbody.append(row);
                        }
                    }
                });
            });
        });
        


$(document).ready(function(){
    $('#upload-form').submit(function(event){
        event.preventDefault(); // Prevent default form submission
        var formData = new FormData(this);

        $.ajax({
            url: '',
            type: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            data: formData,
            processData: false,
            contentType: false,
            success: function(data){
                var sheetsData = data.sheets_data;
                updateTable(sheetsData); // Update table with retrieved data

                // Clear file input field after successful submission
                $('#file-input').val('');
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', status, error);
            }
        });
    });
});


let spanbtn = document.getElementById("spanbtn")
    let fileinp = document.getElementById("fileinp")

    spanbtn.addEventListener('click' , ()=>{
        console.log(fileinp.click());
    })
    </script>
</body>
</html>